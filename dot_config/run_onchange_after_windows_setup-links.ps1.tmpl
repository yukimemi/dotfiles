{{ if eq .chezmoi.os "windows" -}}
$ErrorActionPreference = "SilentlyContinue"

function New-Junction {
    param ([string]$link, [string]$target)
    if (Test-Path $link) {
        $existingTarget = (Get-Item $link).Target
        if ($existingTarget -eq $target) {
            return
        }
        Write-Host "Updating Junction: $link -> $target (was $existingTarget)"
        Remove-Item $link -Force
    }
    $parent = Split-Path $link -Parent
    if (!(Test-Path $parent)) {
        New-Item -ItemType Directory -Path $parent -Force | Out-Null
    }
    Write-Host "Creating Junction: $link -> $target"
    cmd /c mklink /j "`"$link`"" "`"$target`""
}

function New-HardLink {
    param ([string]$link, [string]$target)
    if (Test-Path $link) {
        # Hardlink target checking is difficult in PowerShell, so we compare with Test-Path
        # For simplicity, if it exists, we skip, but we could force update if needed.
        return
    }
    $parent = Split-Path $link -Parent
    if (!(Test-Path $parent)) {
        New-Item -ItemType Directory -Path $parent -Force | Out-Null
    }
    if (Test-Path $target) {
        Write-Host "Creating HardLink: $link -> $target"
        New-Item -ItemType HardLink -Path $link -Target $target
    }
}

# --- Directory Junctions ---
$home = $env:USERPROFILE
$config = Join-Path $home ".config"

$junctions = @{
    "AppData\Roaming\rhq"         = "$config\rhq"
    "AppData\Roaming\copyq"       = "$config\copyq"
    "AppData\Roaming\helix"       = "$config\helix"
    "AppData\Roaming\nushell"     = "$config\nushell"
    "AppData\Roaming\jj"          = "$config\jj"
    "AppData\Roaming\yazi\config" = "$config\yazi"
    "AppData\Local\nvim"          = "$config\nvim"
    "vimfiles"                    = "$config\nvim"
}

foreach ($rel in $junctions.Keys) {
    New-Junction -link (Join-Path $home $rel) -target $junctions[$rel]
}

# --- File Links ---
$files = @{
    "_vimrc"  = (Join-Path $home ".vimrc")
    "_gvimrc" = (Join-Path $home ".gvimrc")
    "AppData\Roaming\Hyper\.hyper.js" = (Join-Path $home ".hyper.js")
}

foreach ($rel in $files.Keys) {
    New-HardLink -link (Join-Path $home $rel) -target $files[$rel]
}

# --- Special Paths ---
# Force change to trigger run_onchange: 2026-02-08
# PowerShell Profile (Link from Documents to ~/.config/powershell/...)
$psProfileTarget = "$config\powershell\Microsoft.PowerShell_profile.ps1"
$myDocs = [Environment]::GetFolderPath("MyDocuments")
$psProfilePaths = @(
    (Join-Path $home "Documents\PowerShell\Microsoft.PowerShell_profile.ps1"),
    (Join-Path $home "Documents\WindowsPowerShell\Microsoft.PowerShell_profile.ps1"),
    (Join-Path $myDocs "PowerShell\Microsoft.PowerShell_profile.ps1"),
    (Join-Path $myDocs "WindowsPowerShell\Microsoft.PowerShell_profile.ps1")
) | Select-Object -Unique

foreach ($path in $psProfilePaths) {
    New-HardLink -link $path -target $psProfileTarget
}

{{ end -}}

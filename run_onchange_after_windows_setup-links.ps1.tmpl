{{ if eq .chezmoi.os "windows" -}}
$ErrorActionPreference = "SilentlyContinue"

function Move-ToBackup {
    param ([string]$path)
    if (Test-Path $path) {
        $timestamp = Get-Date -Format "yyyyMMddTHHmmssfffffff"
        $leaf = Split-Path $path -Leaf
        $backupName = "$leaf.$timestamp.bak"
        Write-Host "Backing up $path to $backupName"
        Rename-Item -Path $path -NewName $backupName -Force
    }
}

function New-Junction {
    param ([string]$link, [string]$target)
    if (Test-Path $link) {
        $item = Get-Item $link
        if ($item.Attributes -match "ReparsePoint") {
            if ($item.Target -eq $target) {
                return
            }
        }
        Move-ToBackup -path $link
    }
    $parent = Split-Path $link -Parent
    if (!(Test-Path $parent)) {
        New-Item -ItemType Directory -Path $parent -Force | Out-Null
    }
    Write-Host "Creating Junction: $link -> $target"
    cmd /c mklink /j "`"$link`"" "`"$target`""
}

function New-HardLink {
    param ([string]$link, [string]$target)
    if (!(Test-Path $target)) {
        Write-Warning "Target not found: $target"
        return
    }
    if (Test-Path $link) {
        # Compare hash to check if it's already the same content
        $hash1 = Get-FileHash -Path $link -Algorithm MD5
        $hash2 = Get-FileHash -Path $target -Algorithm MD5
        if ($hash1.Hash -eq $hash2.Hash) {
            return
        }
        Move-ToBackup -path $link
    }
    $parent = Split-Path $link -Parent
    if (!(Test-Path $parent)) {
        New-Item -ItemType Directory -Path $parent -Force | Out-Null
    }
    Write-Host "Creating HardLink: $link -> $target"
    New-Item -ItemType HardLink -Path $link -Target $target
}

# --- Directory Junctions ---
$home = $env:USERPROFILE
$config = Join-Path $home ".config"

$junctions = @{
    "AppData\Roaming\rhq"         = "$config\rhq"
    "AppData\Roaming\copyq"       = "$config\copyq"
    "AppData\Roaming\helix"       = "$config\helix"
    "AppData\Roaming\nushell"     = "$config\nushell"
    "AppData\Roaming\jj"          = "$config\jj"
    "AppData\Roaming\yazi\config" = "$config\yazi"
    "AppData\Local\nvim"          = "$config\nvim"
    "vimfiles"                    = "$config\nvim"
}

foreach ($rel in $junctions.Keys) {
    New-Junction -link (Join-Path $home $rel) -target $junctions[$rel]
}

# --- File Links ---
$files = @{
    "_vimrc"  = (Join-Path $home ".vimrc")
    "_gvimrc" = (Join-Path $home ".gvimrc")
    "AppData\Roaming\Hyper\.hyper.js" = (Join-Path $home ".hyper.js")
}

foreach ($rel in $files.Keys) {
    New-HardLink -link (Join-Path $home $rel) -target $files[$rel]
}

# --- Special Paths ---
# PowerShell Profile (Link from Documents to ~/.config/powershell/...)
$psProfileTarget = "$config\powershell\Microsoft.PowerShell_profile.ps1"
$myDocs = [Environment]::GetFolderPath("MyDocuments")
$psProfilePaths = @(
    (Join-Path $home "Documents\PowerShell\Microsoft.PowerShell_profile.ps1"),
    (Join-Path $home "Documents\WindowsPowerShell\Microsoft.PowerShell_profile.ps1"),
    (Join-Path $myDocs "PowerShell\Microsoft.PowerShell_profile.ps1"),
    (Join-Path $myDocs "WindowsPowerShell\Microsoft.PowerShell_profile.ps1")
) | Select-Object -Unique

foreach ($path in $psProfilePaths) {
    New-HardLink -link $path -target $psProfileTarget
}

{{ end -}}
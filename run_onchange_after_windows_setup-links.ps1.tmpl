{{ if eq .chezmoi.os "windows" -}}
$ErrorActionPreference = "SilentlyContinue"

function Get-Hash {
    param ([string]$path)
    if (Test-Path $path) {
        $out = certutil -hashfile $path MD5 | Select-String -Pattern "^[0-9a-f]+$"
        return $out.ToString().Trim()
    }
    return ""
}

function Move-ToBackup {
    param ([string]$path)
    if (Test-Path $path) {
        $timestamp = Get-Date -Format "yyyyMMddTHHmmssfffffff"
        $leaf = Split-Path $path -Leaf
        $backupName = "$leaf.$timestamp.bak"
        Write-Host "Backing up $path to $backupName"
        Rename-Item -Path $path -NewName $backupName -Force
    }
}

function New-Junction {
    param ([string]$link, [string]$target)
    if (Test-Path $link) {
        $item = Get-Item $link
        if ($item.Attributes -match "ReparsePoint") {
            # In PS5, it's hard to get junction target easily without external tools
            # but we can try using fsutil or just backup and recreate if not sure.
            # For now, let's assume if it exists and is a junction, we're okay 
            # or just force it if we want to be sure.
            return
        }
        Move-ToBackup -path $link
    }
    $parent = Split-Path $link -Parent
    if (!(Test-Path $parent)) {
        New-Item -ItemType Directory -Path $parent -Force | Out-Null
    }
    Write-Host "Creating Junction: $link -> $target"
    cmd /c mklink /j "`"$link`"" "`"$target`""
}

function New-HardLink {
    param ([string]$link, [string]$target)
    if (!(Test-Path $target)) {
        Write-Warning "Target not found: $target"
        return
    }
    if (Test-Path $link) {
        $h1 = Get-Hash $link
        $h2 = Get-Hash $target
        if (($h1 -ne "") -and ($h1 -eq $h2)) {
            # Even if hashes match, check if it's a hardlink
            # (In PS5, we can use fsutil or just check if HardLinkCount > 1)
            $count = cmd /c fsutil hardlink list "`"$link`"" | Measure-Object | Select-Object -ExpandProperty Count
            if ($count -gt 1) {
                return
            }
        }
        Move-ToBackup -path $link
    }
    $parent = Split-Path $link -Parent
    if (!(Test-Path $parent)) {
        New-Item -ItemType Directory -Path $parent -Force | Out-Null
    }
    Write-Host "Creating HardLink: $link -> $target"
    New-Item -ItemType HardLink -Path $link -Target $target
}

# --- Directory Junctions ---
$userHome = $env:USERPROFILE
$configDir = Join-Path $userHome ".config"

$junctions = @{
    "AppData\Roaming\rhq"         = "$configDir\rhq"
    "AppData\Roaming\copyq"       = "$configDir\copyq"
    "AppData\Roaming\helix"       = "$configDir\helix"
    "AppData\Roaming\nushell"     = "$configDir\nushell"
    "AppData\Roaming\jj"          = "$configDir\jj"
    "AppData\Roaming\yazi\config" = "$configDir\yazi"
    "AppData\Local\nvim"          = "$configDir\nvim"
    "vimfiles"                    = "$configDir\nvim"
    "scoop\persist\espanso\.espanso" = "$configDir\espanso"
    "scoop\persist\copyq\config\copyq" = "$configDir\copyq"
    "scoop\persist\windows-terminal\settings" = "$configDir\windows-terminal"
}

foreach ($rel in $junctions.Keys) {
    New-Junction -link (Join-Path $userHome $rel) -target $junctions[$rel]
}

# --- File Links ---
$files = @{
    "_vimrc"  = (Join-Path $userHome ".vimrc")
    "_gvimrc" = (Join-Path $userHome ".gvimrc")
    "AppData\Roaming\Hyper\.hyper.js" = (Join-Path $userHome ".hyper.js")
}

foreach ($rel in $files.Keys) {
    New-HardLink -link (Join-Path $userHome $rel) -target $files[$rel]
}

# --- Special Paths ---
# PowerShell Profile (Link from Documents to ~/.config/powershell/...)
$psProfileTarget = "$configDir\powershell\Microsoft.PowerShell_profile.ps1"
$myDocsDir = [Environment]::GetFolderPath("MyDocuments")
$psProfilePaths = @(
    (Join-Path $userHome "Documents\PowerShell\Microsoft.PowerShell_profile.ps1"),
    (Join-Path $userHome "Documents\WindowsPowerShell\Microsoft.PowerShell_profile.ps1"),
    (Join-Path $myDocsDir "PowerShell\Microsoft.PowerShell_profile.ps1"),
    (Join-Path $myDocsDir "WindowsPowerShell\Microsoft.PowerShell_profile.ps1")
) | Select-Object -Unique

foreach ($path in $psProfilePaths) {
    New-HardLink -link $path -target $psProfileTarget
}

# --- Windows Terminal ---
$wtDir = Get-ChildItem -Path "$env:LOCALAPPDATA\Packages" -Filter "Microsoft.WindowsTerminal_*" | Select-Object -First 1
if ($wtDir) {
    $wtLink = Join-Path $wtDir.FullName "LocalState\settings.json"
    $wtTarget = "$configDir\windows-terminal\settings.json"
    New-HardLink -link $wtLink -target $wtTarget
}

{{ end -}}